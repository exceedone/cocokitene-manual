# (上級者向け)通知処理の遅延実行
Exmentでは、通常はすべての処理を同期実行していますが、一部の処理を遅延実行(キュー実行)することができます。  
そのため、画面での処理時間を短縮し、時間のかかる処理を後ほど実行することができます。  

現在、以下の処理が遅延実行に対応しています。

- メール送信
- Slack送信
- Microsoft送信

## 注意点
- 処理の遅延実行では、ジョブをキューに保持しておき、画面とは別のプロセスで、処理を実行することになります。  
- キューに保持しておいたジョブを実行するためには、コマンドでキューワーカの実行が必要になります。このワーカは継続して実行する必要があり、**ワーカが止まってしまうと、処理は実行されません。**  
そのため、キューワーカの監視を行うなど、細心の注意をはらうよう、お願いします。
- 処理は遅延実行されるため、画面から通知の実行を呼び出したタイミングでは、「通知が成功したか」「失敗したか」ということをキャッチすることができません。  
そのため、実際には通知が失敗していても、「通知が実行されました！」というメッセージが表示される場合があります。
- キュー処理の詳細は、[Laravelマニュアル](https://readouble.com/laravel/6.x/ja/queues.html)をご参照ください。


## 設定手順
- キュードライバーの設定を行います。今回はデータベースを使用します。（設定により、Redisなどの利用も可能です）

- .envを開き、以下の設定を記入します。

```
#キュードライバー。初期値はsync(同期処理)
QUEUE_DRIVER=database
```

- 以下のコマンドを実行します。キュー情報を保持するためのテーブルを作成します。

```
php artisan queue:table
php artisan queue:failed-table
php artisan migrate
```

- 以下のコマンドを実行します。  
このコマンドを実行した場合、皆さんが停止するか、ターミナルを閉じるまで実行し続けることに注意してください。

> バックグランドでqueue:workプロセスを永続的に実行し続けるには、キューワーカが止まらずに実行し続けていることを確実にするため、[Supervisor](https://readouble.com/laravel/6.x/ja/queues.html#supervisor-configuration)のようなプロセスモニタを利用する必要があります。

```
php artisan queue:work
```


## システムのアップデート時
キューワーカは長時間起動プロセスであるため、リスタートしない限りコードの変更を反映しません。ですから、キューワーカを使用しているアプリケーションをデプロイする一番シンプルな方法は、デプロイ処理の間、ワーカをリスタートすることです。queue:restartコマンドを実行することで、全ワーカを穏やかに再起動できます。

```
php artisan queue:restart
```


## 実行中ジョブの確認
現在実行しているジョブの確認方法です。

- データベースに接続し、以下のコマンドを実行します。

```
select * from jobs;
```

- 現在実行しているジョブの一覧が表示されます。


## 実行失敗ジョブの確認
ジョブの実行が失敗したジョブの確認方法です。

- データベースに接続し、以下のコマンドを実行します。

```
select * from failed_jobs;
```

- 実行失敗したジョブの一覧が表示されます。
