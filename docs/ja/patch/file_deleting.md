# 不具合修正 物理削除済のデータに紐付く、ファイル削除処理

### 対象バージョン
v4.0.6以下

## 背景
- 本来であれば、カスタムデータの物理削除時に、そのデータに紐付くファイル（ここでは、「添付ファイル」、カスタム列の「ファイル」「画像」を指す）を削除する処理が必要でした。  

- v4.0.6以下で、その処理が考慮漏れになっており、データを削除しても、ファイルが残り続けるという不具合が発生していました。

- 本対応では、すでに物理削除を実施しており、どのデータにも紐付かなくなったファイルを削除する処理になります。


## 対応手順

- データのバックアップを実施します。バックアップは、[こちら](/ja/backup)を実施してください。

- また、今回はデータの削除も関わる対応のため、手動でのバックアップも推奨しています。フォルダstorage/app/adminフォルダを、他のフォルダ（作業フォルダなど）にコピーし、バックアップを保持しておきます。

- 以下のコマンドを実施します。

```
php artisan exment:patchdata delete_junk_file (テーブル名)

例：「お知らせ(information)」テーブルのファイルを削除する場合
php artisan exment:patchdata delete_junk_file information
```

- これにより、削除されたデータのファイルを削除します。  
※どのテーブルのファイルを削除するかを明確化するため、都度テーブル名を指定してのコマンド実行としています。


## (補足)内部処理詳細
内部処理についてご説明します。

### 物理削除済のfilesデータを削除
DBのテーブル「files(アップロードしたファイル名や、紐付くカスタムデータのIDなどを保持するテーブル)」から、すでに物理削除済みのカスタムデータに紐付く行を削除します。

- 入力したテーブル名をキーに、DBのテーブル「files」を検索し、一覧を取得します。

- filesの各データに対し、登録されているparent_id(カスタムデータのID)をキーにして、カスタムデータを検索します。

- カスタムデータが存在しない場合、すでに論理削除済のデータとみなし、filesテーブルから該当行を物理削除します。

### 紐付かなくなったファイルを削除
サーバー上にあるファイルのうち、すでに物理削除済のデータに関するファイルを削除します。

- 「storage/app/admin/(テーブル名)」 フォルダ内のファイル一式を取得し、ファイル名でループを実施します。  

- ファイル名をキーに、DBのテーブル「files」を検索します。

- filesテーブルに、該当のデータが無ければ、そのファイルを削除します。


## 復元する場合
- なんらかの理由でデータの復元をする場合、作成しておいたバックアップファイルをリストアするか、ローカルにコピーしておいたファイル一式を、「storage/app/admin/」に戻してください。


## v4.0.7以降について
- v4.0.7以降では、カスタムデータの物理削除実施時に、紐付くファイルは自動的に削除されます。

- なお、同アップデートで、カスタムデータでの削除を、常に物理削除にするオプションも追加しております。  
設定方法は、[こちら](/ja/config#論理削除を利用せず、常に物理削除を行う)をご確認ください。