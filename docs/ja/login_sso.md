# ログイン設定(SSO)
Exmentにログインを行う時の、各種ログイン設定を行います。  
このページでは、特にシングルサインオン(SSO)に関する内容を記載します。

## ログイン方式
Exmentでは、標準のログイン以外にも、様々なログイン方式が用意されています。  
以下、そのログイン方式について記載します。

### 標準
Exmentで作成したデータベースに、ユーザーを登録、パスワードを設定して、Exmentのデータベースと連携してログインを行う方式です。  


### OAuth
OAuth形式のシングルサインオンで、ログインを行う方式です。  
ログインボタンをクリックした時に、あらかじめ登録していたプロバイダのログイン画面にリダイレクトして、ログインを行います。  

- [シングルサインオン(OAuth)](/ja/login_oauth)
  
※プロバイダ例：  

- Google
- Facebook
- Office365


### SAML
SAML形式のシングルサインオンで、ログインを行う方式です。  
ログインボタンをクリックした時に、あらかじめ登録していたプロバイダのログイン画面にリダイレクトして、ログインを行います。  
  
- [シングルサインオン(SAML)](/ja/login_saml)
  
※プロバイダ例：  

- OpenAM
- Keycloak
- ADFS


### LDAP
LDAP形式で、ログインを行う方式です。  
Exmentのログインページで、ID・パスワード欄にユーザー情報を入力し、ログインボタンをクリックすることで、LDAP認証を行い、ユーザー情報を連携します。  
  
- [ログイン設定(LDAP)](/ja/login_ldap)
  
※プロバイダ例：  

- Active Directory


## ログイン設定管理方法

- システム管理者が、以下のURLを入力します。  
http(s)://(ExmentのURL)/admin/log_setting  
※上記で記載の「システム設定変更」を行うことで、アクセスが出来るようになります。

- もしくは、メニューに「ログイン設定」を追加します。  
「管理者設定」 > 「メニュー」ページを開き、メニュー種類「システムメニュー」を選択すると、対象の「ログイン設定」が表示されますので、選択し、保存を行ってください。  
※「ログイン設定」は、デフォルトの設定ではメニューに表示されません。

![ログイン設定一覧](img/login/login_setting4.png)  

- 新規のSSOプロバイダを追加する場合は、右上の「＋新規」ボタンをクリックします。  
    - [シングルサインオン(OAuth)](/ja/login_oauth)
    - [シングルサインオン(SAML)](/ja/login_saml)
    - [ログイン設定(LDAP)](/ja/login_ldap)
  

### SSO設定
SSO全体の設定を管理します。  
※有効になっているSSOが1件以上存在する場合のみ表示されます。

#### 既定のログインを表示する
YESに設定した場合、ExmentのID・パスワードを使用したログインフォームと、ログインボタンを表示します。  
※SAML、OAuthによるログインのみで、この設定をNOにすることで、ユーザーIDとパスワードを入力する既定のログインフォームが非表示になります。

![SSOログイン画面](img/quickstart/sso1.png)


#### SSOログインにリダイレクト
YESに設定した場合、ユーザーがログイン画面に遷移した時、Exmentのログインページを表示せず、SSOのログインページに直接リダイレクトします。  
※SAML、OAuthによるプロバイダが、合計1件のみの場合に有効になります。

#### ログイン許可ドメイン
ログインを許可するドメインを指定する場合は記入してください。複数ある場合は改行区切りで記入してください。  
入力したドメイン以外のユーザーがログインを行った場合、エラーが表示されます。  



### SSOログイン設定無効化
何らかの理由で、SSOログイン設定を強制的に無効にしたい場合、以下の設定を行ってください。

- プロジェクトのフォルダより、「.env」ファイルを開き、以下のように追記を行ってください。  
※設定ファイルの編集方法について、詳細は[こちら](/ja/config)をご参照ください。

~~~
EXMENT_CUSTOM_LOGIN_DISABLED=true
~~~

この設定を行うことで、ログイン画面で、通常のID・パスワードによるログインフォームが表示されます。


### SSOログイン時のバリデーションについて
SSOログインを実施時に、プロバイダから受け取ったユーザー情報（以下「プロバイダユーザー」）をもとに、バリデーションを実施します。  
以下のようなルールで、バリデーションを実施します。  

- ユーザーテーブルの各列で、「必須」に設定されている列情報が、プロバイダユーザーに含まれていなかった場合、エラーとなります。
- SSO設定で、「ユーザー新規作成」がYESで、はじめてExmentにログインする場合、Exmentで設定しているユーザー設定を使用し、バリデーションを行います。（使用可能文字設定、文字列の長さなど）
- SSO設定で、「ユーザー情報を更新する」がYESで、すでにExmentに登録しているユーザーでログインを行った場合、Exmentで設定しているユーザー設定を使用し、バリデーションを行います。（使用可能文字設定、文字列の長さなど）

バリデーションエラーになった場合、エラーとなった原因を画面表示します。また、ログファイルにも、エラーとなった原因を出力します。


### その他
- v3.3.0未満からv3.3.0以上にアップデートした場合で、ユーザーコードに「ドット(.)」を含んだプロバイダでログインを行った場合、エラーとなることがあります。  
その場合、以下の対応を行ってください。
    - 「ユーザー」テーブルの「カスタム列設定」で、「ユーザーコード」列の編集画面に遷移する。
    - 「使用可能文字」オプションで、「ドット」にチェックを入れて保存する。


- 既定の動作では、ログイン状態でブラウザを閉じた場合でも、一定時間（120分）経過するまでは、ログイン状態を維持します。  
v3.6.0以降で、ログイン状態でブラウザを閉じた場合に、自動的にログアウトにする場合には、「.env」ファイルを開き、以下のように追記を行ってください。  
※設定ファイルの編集方法について、詳細は[こちら](/ja/config)をご参照ください。

~~~
EXMENT_SESSION_EXPIRE_ON_CLOSE=true
~~~


