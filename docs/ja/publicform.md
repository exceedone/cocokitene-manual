# 公開フォーム設定
一般ユーザー（ログインしていないユーザー）がデータを入力できる、公開フォームを設定します。  
  
通常の[データフォーム画面](/ja/data_form.md)を利用するためには、事前にユーザーを用意したうえで、ID・パスワードを入力してログインしてもらう必要があります。公開フォームは、ログイン不要で誰でもデータを入力することができます。  
これにより、アンケートや問い合わせフォーム、申請フォームなどを作成し、URLを共有して、広く外部に公開することが出来ます。  

## 公開フォーム設定の仕様について

<span class="red bold">公開フォーム設定より入力したデータは、公開フォーム設定を登録したユーザーが、作成ユーザー・更新ユーザーとして登録されます。</span>  
また、データ入力画面では、動的に他テーブルの選択肢を取得したり検索したりすることがありますが、その際の役割・権限も、公開フォーム設定を登録したユーザーとして扱います。  
  
そのため、システム管理者が公開フォームを登録することは、避けてください。  
後述の「<a href="#/ja/publicform?id=role_user">公開フォーム設定を行うユーザー・役割グループ設定</a>」の手順で、新しいユーザー・役割グループを設定することを推奨します。   
  
また、以下のテーブルは、公開フォームの設定対象外です。  
- 「ユーザー」や「組織」などのマスターテーブル
- テーブル設定で「1件のみ登録可能」にしているテーブル


## 設定の流れ
以下の流れで、公開フォームを設定します。

1. コマンド実行します。(Google reCAPTCHAを使用する場合)

2. システム設定画面で、公開フォーム設定を有効にします。

3. [カスタムフォーム設定](/ja/form)を行い、フォームに表示する項目・見出しなどの情報を設定します。

4. 公開フォーム設定を行うユーザー・役割グループを登録します。

5. 上記ユーザーでログインして、公開フォーム設定を行い、各種デザイン、確認画面、Googleアナリティクスなどを設定します。

6. 公開フォームを有効化すると、URLが発行されます。

## 設定手順

### 1. コマンド実行
公開フォームで、Google reCAPTCHAを使用する場合のみ、実行します。  
プロジェクトのルートフォルダで、以下のコマンドを実行してください。  

```
composer require arcanedev/no-captcha=^10.1
```

### 2. システム設定画面
- [システム設定画面](/ja/system_setting)の「STEP2 詳細設定」に遷移し、「公開フォームを使用する」をYESにします。  
※既定ではNOになっています。これは、公開フォームを使用することを、明示的に選択してもらうためです。  

![カスタムフォーム画面](img/form/system1.png)

- Google reCAPTCHAを使用したい場合には、「Google reCAPTCHA」の項目を、V2もしくはV3に設定してください。  
選択後、Google reCAPTCHAのサイトキーとシークレットキー項目が表示されるので、[Google reCAPTCHAの管理ページ](http://www.google.com/recaptcha/admin)よりコピーした値を設定してください。  
※設定後、各公開フォーム設定画面で、Google reCAPTCHAを使用するかどうかを選択します。

![カスタムフォーム画面](img/form/system2.png)


### 3. カスタムフォーム設定
- [カスタムフォーム設定](/ja/form)を行い、フォームに表示する項目・見出しなどの情報を設定します。この手順は、基本的に、通常のフォーム設定と同様です。  
※この設定は管理者など、公開フォーム設定ユーザー以外が行っても問題ありません。

<h3 id="role_user"><a href="#/ja/publicform#role_user" data-id="role_user" class="anchor"><span>4. 公開フォーム設定を行うユーザー・役割グループ設定</span></a></h3>
公開フォーム設定を行うユーザー・役割グループを登録します。  
公開フォームから送信されたデータは、このユーザーが登録・更新したものとして扱われます。

- [役割グループ設定](/ja/role_group)を新規作成します。
    - 「公開フォーム管理」権限を追加します。
	- 公開フォームを設定したいテーブルに対し、編集権限を追加します。
    - ならびに、その公開フォームでアクセスするテーブルの、閲覧権限も追加します。  

- 例：「お問い合わせ」テーブルの公開フォームを設定予定で、お問い合わせテーブルでは、「製品」「カテゴリ」テーブルのすべてのデータを参照している場合：  
    - 「お問い合わせ」テーブルの「公開フォーム管理」「担当者データの編集」権限
    - 「製品」「カテゴリ」テーブルの「全データの閲覧」権限

![カスタムフォーム画面](img/form/authority.png)

- 公開フォームを管理するユーザーを追加します。
    - 役割グループは、上記で作成した役割グループを選択します。

- 上記で作成したユーザーでログインを行い、公開フォーム設定画面を表示し、公開フォームを登録してください。


### 5. 公開フォーム設定

- カスタムテーブル一覧で、設定を行いたいテーブルにチェックを1つ入れ、右上の「テーブル詳細設定」をクリックします。  
![カスタムフォーム画面](img/form/form_grid3.png)
> ※ 対象となるカスタムテーブルのデータ一覧画面やデータ登録画面から、直接遷移することも可能です。その場合も右上の「テーブル詳細設定」をクリックしてください。  
![カスタムフォーム画面](img/form/form_grid4.png)
- 表示されたテーブル詳細設定の画面で、フォーム設定のアイコンをクリックします。
![カスタムフォーム画面](img/form/form_grid5.png)

- フォーム一覧画面の下部に、「公開フォーム設定」ボックスが追加されています。  
このボックス内の右上にある「＋新規」ボタンをクリックしてください。

![カスタムフォーム画面](img/form/add_public_form.png)

- 公開フォーム設定画面に遷移します。必要な項目を設定してください。

#### 設定内容 - 基本設定
![カスタムフォーム画面](img/form/public_form_basic_setting.png)

- ##### 対象フォーム
公開フォームとして設定するフォームを選択します。上記の「カスタムフォーム設定」で作成したフォームを選択してください。

- ##### 公開フォーム表示名
一覧画面などで表示する表示名を入力してください。

- ##### 公開有効期限
フォームを公開する期限を設定する場合は、開始日時と終了日時を入力してください。  
※「開始日時」もしくは「終了日時」のみ入力することもできます。どちらも未入力の場合、常に有効になります。  
※公開有効期限外の場合、この公開フォームが使用できなくなります。


#### 設定内容 - デザイン設定
![カスタムフォーム画面](img/form/public_form_set_with.png)

ヘッダー・フッターの使用有無、ロゴ画像や文言、フォームの背景色、などのデザイン要素を設定します。  


#### 設定内容 - 回答確認・完了設定
ユーザーがフォームの入力を完了したタイミングで表示する「回答確認画面」と「完了画面」の使用有無、およびタイトルや文言などの設定を行います。

![カスタムフォーム画面](img/form/public_form_answer_confirmation_setting.png)

- ##### 回答確認を使用する
YESの場合、ユーザーの画面遷移が以下のような流れになります。

```
入力画面 → 確認画面 → 完了画面(データ登録)
```

※NOの場合、ユーザーの画面遷移が以下のような流れになります。

```
入力画面 → 完了画面(データ登録)
```

- ##### 確認タイトル
回答確認画面のタイトル文言を入力してください。

- ##### 確認テキスト
確認画面のページ上部に表示するテキスト・HTMLを入力してください。  
※[パラメータ](/ja/params)を使用できます。スクリプトは実行できません。



- ##### 完了タイトル
完了画面のタイトル文言を入力してください。

- ##### 完了テキスト
完了画面のページ上部に表示するテキスト・HTMLを入力してください。  
※[パラメータ](/ja/params)を使用できます。スクリプトは実行できません。

- ##### 完了リンク先URL
完了画面に、リンクを表示することができます。入力後に別画面に遷移させたい場合は、遷移先のURLを入力してください。  
※「完了リンク先テキスト」の入力がなかった場合、入力したURLが、そのままリンクのテキストとして表示されます。

- ##### 完了リンク先テキスト
完了画面に、リンクを表示することができます。入力後に別画面に遷移させたい場合、リンクとして画面に表示する文言を入力してください。  


#### 完了通知(一般ユーザー)
データを入力した一般ユーザーに、登録完了後、メールを送信することができます。  
システムにログインしていない一般のユーザー向けの通知のため、通知方法はEメール送信のみになります。  
また、通知先は、一般ユーザーが記入したEメールアドレスのみになります。  
※この機能を使用するためにはカスタムテーブルに列種類：Eメールの列が必要です。

- ##### 完了通知を一般ユーザーに行う
YESにすることで、完了通知が有効になります。 

- ##### 通知テンプレート
一般ユーザーに送付する通知テンプレートを選択してください。事前に[通知テンプレート設定](/ja/mail)で、新しいテンプレートを作成していただく必要があります。  
※通知には、[変数(パラメータ)](/ja/params)を使用できます。変数を使用することで、登録しているデータやシステム名、ユーザーの入力値などを、件名・本文に追加することができます。  

- ##### 通知対象
通知対象となるメールアドレスが設定されている、カスタム列を選択してください。  
例：入力項目に、「返信先メールアドレス」列がある場合、この列を通知対象に選択することで、データ入力完了後に、そのメールアドレスに通知が送信されます。  


#### 完了通知(管理者)
データ入力完了後、管理者に通知を送信することができます。  
※「管理者」と記入していますが、管理者ならびにExmentに登録されているユーザー、Slackなどに通知を行うことが可能です。

- ##### 完了通知を管理者に行う
YESにすることで、完了通知が有効になります。 

- ##### 通知テンプレート
管理者に送付する通知テンプレートを選択してください。事前に[通知テンプレート設定](/ja/mail)で、新しいテンプレートを作成していただく必要があります。  
※通知には、[変数(パラメータ)](/ja/params)を使用できます。変数を使用することで、登録しているデータやシステム名、ユーザーの入力値などを、件名・本文に追加することができます。  

- ##### 通知対象
通知対象を選択してください。  
※通知対象の項目や設定方法は、[通知アクション設定](/ja/notify#通知アクション設定)をご確認ください。




#### 設定内容 - エラー設定
エラーが発生した場合の制御を行います。

![カスタムフォーム画面](img/form/public_form_error_setting.png)


- ##### エラータイトル
エラー画面のタイトルの文言を入力してください。

- ##### エラーテキスト
エラー画面のページ上部に表示するテキスト・HTMLを入力してください。  

- ##### エラーリンク先URL
エラー画面に、リンクを表示することができます。エラー発生時に別画面に遷移させたい場合は、遷移先のURLを入力してください。  
※「エラーリンク先テキスト」の入力がなかった場合、入力したURLが、そのままリンクのテキストとして表示されます。

- ##### エラーリンク先テキスト
エラー画面に、リンクを表示することができます。エラー発生時に別画面へのリンクを表示する場合は画面に表示する文言を入力してください。  

#### エラー通知
エラーが発生した場合に、管理者に通知を行うことができます。  
※「管理者」と記入していますが、管理者ならびにExmentに登録されているユーザー、Slackなどに通知を行うことが可能です。

- ##### エラー通知を行う
YESにすると、エラーが発生した場合に、管理者に通知を行います。

- ##### 通知テンプレート
管理者に送付するテンプレートを選択してください。事前に[通知テンプレート設定](/ja/mail)で、新しいテンプレートを作成していただく必要があります。  
※通知には、[変数(パラメータ)](/ja/params)を使用できます。変数を使用することで、登録しているデータやシステム名、ユーザーの入力値、エラー内容などを、件名・本文に追加することができます。  

- ##### 通知対象
通知対象を選択してください。  
※通知対象の項目や設定方法は、[通知アクション設定](/ja/notify#通知アクション設定)をご確認ください。


#### CSS・Javascript
独自のCSSならびにJavascriptを追加することができます。

![カスタムフォーム画面](img/form/public_form_css_javascript.png)

- ##### カスタムCSS
使用したいCSSを直接記入してください。  
※&lt;style&gt;タグは不要です。cssの中身のみ記入してください。

- ##### プラグイン(CSS)
インストールされているプラグイン(CSS)を、公開フォームにも反映させる場合、プラグインの名称を選択してください。

- ##### カスタムJavascript
使用したいJavascriptを直接記入してください。  
※&lt;script&gt;タグは不要です。Javascriptの中身のみ記入してください。  
※Javasciptは、以下のjquery内に追加されます。

``` javascript
<script data-exec-on-popstate>
    $(function () {
        (追加したコード)
    });
</script>
```

- ##### プラグイン(Javascript)
インストールされているプラグイン(Javascript)を、公開フォームにも反映させる場合、プラグインの名称を選択してください。



#### 設定内容 - オプション設定
その他のオプション設定を行います。

![カスタムフォーム画面](img/form/public_form_option_setting.png)

- ##### 初期値をURLから設定可能にする
YESにすることで、URLのクエリ文字列の値を、フォームの初期値として設定することができます。詳細は[こちら](#初期値をURLから設定)をご確認ください。

- ##### Googleアナリティクス
フォームにGoogleアナリティクスを設定する場合、「UA-」もしくは「G-」から始まる、Google Analyticsのタグを入力してください。

- ##### Google reCAPTCHAを使用する
Google reCAPTCHAを使用する場合、YESにしてください。  
※システム設定画面で、Google reCaptchaのキーを入力していた場合のみ、有効になります。


#### プレビュー
- 設定している内容を元に、公開フォームのプレビューを表示することができます。  
※フォームを保存していなくてもプレビュー可能です。  

- 画面右上の「プレビュー」ボタンをクリックすることで、別ウィンドウで公開フォームのプレビュー画面が表示されます。  
※javascriptにより、別ウィンドウ表示を実施します。ブラウザ設定によって、ポップアップがブロックされる場合があります。その際は、ブロックを解除し、再度ボタンをクリックしてください。

![カスタムフォーム画面](img/form/public_form_preview.png)

#### 公開フォームを有効化する
- フォームを一般ユーザーに公開するためには「有効化する」必要があります。一度保存を行ってから、あらためて編集画面を開き、ページ右上の「有効化する」ボタンをクリックしてください。  

![カスタムフォーム画面](img/form/public_form_activation_button.png)

![カスタムフォーム画面](img/form/public_form_activation_confirmation.png)


- 公開するフォームが、他のテーブルへの参照を含んでいる場合、一般ユーザーがこれらのテーブルからデータを読み取ることになります。  
以下のような確認メッセージが表示されますので、アクセスするテーブルに問題がないか、十分にご確認ください。  

![カスタムフォーム画面](img/form/public_form_dialog.png)

- 「他のテーブルへのアクセス」とは、主に以下のようなものがあります。
    - 公開フォームに、列種類「選択肢(他のテーブルの値一覧から選択)」「ユーザー」などの項目がある場合、選択肢候補としてデータの表示、検索が実施される。
    - 公開フォームが1:nの子テーブルの場合、親テーブルのデータが選択肢として表示・検索される。




#### 有効化実施後、URLなど表示
- 公開フォームを有効化することで、基本設定に、以下の項目が追加されます。

- ##### 公開フォームURL
公開フォームのURLが表示されます。このURLをコピーして、メールや自社サイトなどで一般ユーザーに共有してください。  
※項目をクリックすると、URLをコピーすることができます。

- ##### 実行ユーザー
公開フォームを登録したユーザーです。この公開フォームを使用したデータの登録や参照はすべて、当該ユーザーの権限で実行されることになります。  
※別のユーザーが公開フォーム設定を更新しても、実行ユーザーは変わりません。変更する場合は別のユーザーでログインした上で、新しい公開フォーム設定を作成してください。



### 6. 公開フォーム使用
- 上記でコピーしたURLにアクセスすると、公開フォームが表示されます。  
![カスタムフォーム画面](img/form/public_form_page.png)

- 公開フォーム設定を「有効化」していない場合や有効期間外の場合、またはURLに誤りがある場合は、以下のエラーが表示されます。  

![カスタムフォーム画面](img/form/public_form_error.png)

### 7. テンプレートを利用
テンプレートを利用することで、既に作成している公開フォームの設定値を引き継いで、新たな公開フォームを作成することができます。
>次の項目に関しては、手動での設定が必要となります。<br />・ヘッダーロゴ<br />・Googleアナリティクス<br />・Google reCAPTCHAを使用する

#### エクスポート
公開フォーム設定画面に表示されている［テンプレート：エクスポート］をクリックすることで、開いている公開フォームがテンプレートとしてエクスポートされます。

![カスタムフォーム画面](img/form/public_form_export.png)

#### テンプレートから作成
カスタムフォーム設定画面の公開フォーム設定にある［+テンプレートから作成］をクリックします。

![カスタムフォーム画面](img/form/public_form_import.png)

##### 対象フォーム
テンプレートを用いて公開フォームを作成するにあたり、対象にするフォームを選択します。

##### 公開フォーム表示名
作成する公開フォームの画面表示名を入力します。

##### アップロード
公開フォームの作成に利用するテンプレートを選択します。

![カスタムフォーム画面](img/form/public_form_import2.png)


## その他詳細設定

### 初期値をURLから設定
- 設定「初期値をURLから設定可能にする」をYESにした場合、公開フォームにアクセスするためのURLに、項目の初期値を入力することができるようになります。  
会社名やカテゴリなど、URLを共有する相手の初期値が分かっている場合に、あらかじめURLに含めておくことで、入力の負担を減らすことができます。

#### 付与方法
以下のようなクエリ文字列を設定します。

```
http://(公開フォームまでのURL)?value.(カスタム列名)=(初期値)

複数列に対して設定する場合には、2つ目以降のvalueは & で繋ぎます。
http://(公開フォームまでのURL)?value.(カスタム列名)=(初期値)&value.(カスタム列名)=(初期値)


# 例
http://localhost/publicform/c4f31330-7a75-11eb-a8b0-279816836d79?value.title=こんにちは

http://localhost/publicform/c4f31330-7a75-11eb-a8b0-279816836d79?value.client_name=株式会社ABC&value.category=初期導入
```

- 例：以下のようなフォームがあった場合  

![カスタムフォーム画面](img/form/public_form_key.png)

- このフォームのURLに、下記のクエリ文字列を追加することで、フォームを開いた時に初期値が設定されます。

```
http://localhost/publicform/ab3d55e4-1afc-d1de-ac1b-bc64c51d4d7d?value.title=問い合わせについて&value.body=こちらは本文です。
```

![カスタムフォーム画面](img/form/public_form_query_result.png)

#### カスタム列「選択肢(他のテーブルから選択)」「ユーザー」「組織」で、suuid(20桁のランダム文字列)でのみ初期値をセットできるようにしたい場合
カスタム列「選択肢(他のテーブルから選択)」「ユーザー」「組織」（以下、単に「選択肢(他のテーブルから選択)」とだけ記載）で、通常、初期値はID(整数の連番)により設定されます。  
しかし、他のユーザーにフォームを公開する場合、URLのパラメータを変更することによって、初期値を容易に推測することが出来てしまいます。  
そのため、これらの列の初期値を、IDではなくsuuid(20桁のランダム文字列)にしたい場合、以下の対応を実施してください。  

- [Exment設定値一覧]で、「公開フォームの『初期値をURLから設定』で、IDではなくsuuidのみ許容する」の設定を実施します。  

``` .env
EXMENT_PUBLICFORM_URLPARAM_SUUID=true
```

- この設定により、「選択肢(他のテーブルから選択)」の列の初期値を、suuidのみ許容するようになります。

- なお、各手順のsuuidは、以下の手順でご確認ください。
    - ビューの「表示列選択」で、内部ID(20桁)を選択する
    - データをエクスポートする

### URLに含む「publicform」の変更
- 公開フォームのURLに含まれる、"publicform"の文字列を変更するための手順です。  
※この文字列は、すべての公開フォームで同一になります。フォーム毎に変更することはできません。

#### 変更手順

- 変更には、[設定値の変更](/ja/config)を実施します。

- Exmentのルートディレクトリで、「.env」ファイルを開きます。

- 以下の値を追加します。

~~~
### 「publicform」を別の名前に変更する場合
EXMENT_PUBLICFORM_ROUTE_PREFIX=afiewqbfwehghwb
# http://localhost/afiewqbfwehghwb/(UUID) が、公開フォームのURLになる
~~~

※なお、本マニュアルではすべて、「publicform」の前提で記載しておりますので、ご了承ください。


### 公開フォーム特有の仕様
その他、公開フォーム特有の仕様です。  

- カスタム列「選択肢(他のテーブルの値一覧から選択)」「ユーザー」「組織」などで表示される「サーチ」ボタンは、公開フォームでは表示されません。  

- テーブル詳細設定の「通知設定」で登録できる、実施トリガー「データ新規作成」の通知は、公開フォームでは実施されません。  
これは、公開フォーム設定で個別に「一般ユーザー向け」「管理者向け」の通知があり、それらの通知と同時に実施しないようにするためです。