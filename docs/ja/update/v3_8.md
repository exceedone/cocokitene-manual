# 更新手順 v3.8.0
version3.8.0では、インポート・エクスポートに関して、いくつか重要な変更を行っています。  
ここでは、事前にご確認いただきたい内容、ならびに設定変更方法を記載しております。


## 事前確認

### 一時ファイル保存用の、フォルダ権限確認

v3.8.0以降では、データのエクスポートの際、ダウンロードファイルをローカルサーバーに一時保存し、そのファイルをダウンロードする方式にしています。  
そのため、ローカルサーバーの以下のパスに、Webサーバーを動作するユーザー(apache, www-dataなど)が、書き込み権限を持っているかどうかの確認をお願いします。  
※特にLinux環境で構築を行っている場合に、権限漏れが発生しやすいです。

```
(ルートフォルダ)/storage/app/admin_tmp
```

### 画面からのインポートでのデータ最大件数を変更

> v3.8.0未満から、v3.8.0以上にアップデートを行う場合に必要な手順です。

v3.8.0以降でインストールを行った場合は、画面からのインポートでのデータ最大件数を、5000件としています。  
ただし、v3.1.7以上、v3.8.0未満で初回インストールを行ったExmentで、v3.8.0以上にアップデートを行った場合は、設定ファイルの導入時期の都合上、画面からのインポートでのデータ最大件数は、1000件と設定されています。  
そのため、v3.8.0以上にアップデートを行う場合で、Exmentのインポート最大件数の変更を5000件に変更する場合は、以下の手順を行ってください。


#### 件数変更方法

- ファイル"config/exment.php"を開きます。

- ファイル内検索で、「import_max_row_count」のある行を探します。

> ここで、「import_max_row_count」行がない場合があります。  
これは、Exmentをはじめてインストールしたバージョンが、v3.1.7未満の場合となります。  
この場合は、インポート最大件数の変更が自動的に5000件になりますので、以下に記載の対応は不要になります。

- import_max_row_countの値を、以下のように修正します。

```
// 変更前
'import_max_row_count' => env('EXMENT_IMPORT_MAX_ROW_COUNT', 1000),

// 変更後
'import_max_row_count' => env('EXMENT_IMPORT_MAX_ROW_COUNT', 5000),
```

<span class="small">※理屈上は、上記の値を5000以上にすれば、最大件数をさらに引き上げられます。その場合の動作検証は行っておりませんので、ご了承ください。</small>


#### (任意)タイムアウト時間変更
大量データの取込で、メモリエラーが発生しにくくなりますが、タイムアウトが発生することはあります。  
タイムアウト時間を伸ばす処理を、はじめからExnentのコードにも追加していますが、環境によってはこの機能が有効にならない場合があるので、その場合は[こちら](/ja/additional_php_ini)の手順で、タイムアウト時間の変更を行ってください。


### インポートコマンドのファイル名形式

[インポートコマンド](/ja/data_cmd_import_export)を実行する場合、v3.8.0未満では、「<span class="bold">連番<span class="red">#</span>(カスタムテーブルの名前).csv</span>」のファイル名形式でのインポートに対応していました。  
v3.8.0で、インポート時のライブラリをSpOutに変更した都合で、このファイル名形式でインポートが不可になりました。  
そのため、連番を指定してのインポートを行う場合は、「<span class="bold">連番<span class="red">.</span>(カスタムテーブルの名前).csv</span>」の形式と変更し、インポートを行ってください。

```
// 変更前
「(連番)#(カスタムテーブルの名前).csv」   ※例：01#client.csv、02#estimate.csv

// 変更後
「(連番).(カスタムテーブルの名前).csv」   ※例：01.client.csv、02.estimate.csv
```


## アップデート
上記の内容をご確認いただきましたら、v3.8.0以降に[アップデート](/ja/update)を行ってください。



## (補足)背景
今回の修正の、技術的背景について記載します。  
  
version3.8.0未満では、データのcsv、xlsxのインポートで、Excelならびにcsvで使用しているライブラリは、[PhpSpreadSheet](https://github.com/PHPOffice/phpspreadsheet/)と呼ばれるものを使用しています。  
こちらは非常に多機能なライブラリとなっており、GitHubのスター数も、2020/12/07現在で9200件となっております。  
    
しかし、**このPhpSpreadSheetは、大量データの取込には向いておりませんでした。**  
実際、さまざまなサイトで、PhpSpreadSheetの大量データ問題について、記載されております。  
  
https://blog.sgnet.co.jp/2018/06/php-phpexcel.html  
https://nextat.co.jp/staff/archives/201  
  
この問題により、たとえPHPで許可するメモリ使用量を無制限の設定にしていたとしても、メモリ超過によるPHPエラーが発生する場合がありました。  
  
そこで今回、**インポートに使用するライブラリを、[SpOut](https://github.com/box/spout)に切り替える対応を行いました。**  
SpOutは、シンプルな分軽量なライブラリとなっており、GitHubのスター数も、2020/12/07現在で3300件となっております。  
  
SpOutに切り替えることによって、画面からのインポートでも、安全に実施できることを確認しています。  
現在、画面からのインポートは、標準で1000件に制限させていただいておりますが、その上限を変更しています。  
※ただし、ご利用のブラウザ設定、ネットワーク環境、サーバー設定などにより、タイムアウトになる場合がありますので、ご了承ください。
  
ならびに、コマンドによるインポートも、環境やインポート件数、対象の列数によって、メモリ超過エラーになることがありましたが、その可能性も大きく抑えられます。  
その他にも、コマンドによるインポート時に、現在取込が完了している件数の随時出力など、一部の処理の改善を行っております。  

ライブラリ切り替えに伴い、インポート・エクスポートの両方で、一部仕様を変更しております。  
